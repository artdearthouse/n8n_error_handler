{
    "name": "n8n_error_handler",
    "nodes": [
        {
            "parameters": {
                "values": {
                    "string": [
                        {
                            "name": "TELEGRAM_CHAT_ID",
                            "value": "YOUR_CHAT_ID"
                        },
                        {
                            "name": "TELEGRAM_THREAD_ID",
                            "value": "YOUR_THREAD_ID"
                        },
                        {
                            "name": "WEBHOOK_URL",
                            "value": "YOUR_WEBHOOK_URL"
                        }
                    ]
                }
            },
            "name": "Config",
            "type": "n8n-nodes-base.set",
            "typeVersion": 1,
            "position": [
                0,
                300
            ]
        },
        {
            "parameters": {},
            "name": "Error Trigger",
            "type": "n8n-nodes-base.errorTrigger",
            "typeVersion": 1,
            "position": [
                0,
                600
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "INSERT INTO error_logs (workflow_name, execution_id, error_message, stack_trace) VALUES ($1, $2, $3, $4)",
                "additionalFields": {
                    "queryParams": "={{$json.workflow.name}},={{$json.execution.id}},={{$json.message}},={{$json.stack}}"
                }
            },
            "name": "Log to DB",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 1,
            "position": [
                250,
                600
            ],
            "credentials": {
                "postgres": {
                    "id": "YOUR_POSTGRES_CREDENTIAL_ID",
                    "name": "Postgres Default"
                }
            }
        },
        {
            "parameters": {
                "rule": {
                    "interval": [
                        {
                            "field": "minutes"
                        }
                    ]
                }
            },
            "name": "Schedule",
            "type": "n8n-nodes-base.cron",
            "typeVersion": 1,
            "position": [
                0,
                900
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "SELECT * FROM error_logs WHERE sent_to_tg = FALSE AND processing_attempts < 5 ORDER BY timestamp ASC LIMIT 50"
            },
            "name": "Fetch Pending",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 1,
            "position": [
                200,
                900
            ],
            "credentials": {
                "postgres": {
                    "id": "YOUR_POSTGRES_CREDENTIAL_ID",
                    "name": "Postgres Default"
                }
            }
        },
        {
            "parameters": {
                "batchSize": 1,
                "options": {}
            },
            "name": "SplitInBatches",
            "type": "n8n-nodes-base.splitInBatches",
            "typeVersion": 1,
            "position": [
                400,
                900
            ]
        },
        {
            "parameters": {
                "chatId": "={{$node[\"Config\"].json[\"TELEGRAM_CHAT_ID\"]}}",
                "text": "=âš ï¸ **Error in {{$json.workflow_name}}**\n\nðŸ“„ Execution: `{{$json.execution_id}}`\nâŒ Message: {{$json.error_message}}",
                "additionalFields": {
                    "messgeThreadId": "={{$node[\"Config\"].json[\"TELEGRAM_THREAD_ID\"]}}"
                }
            },
            "name": "Telegram",
            "type": "n8n-nodes-base.telegram",
            "typeVersion": 1,
            "position": [
                600,
                800
            ],
            "credentials": {
                "telegramApi": {
                    "id": "YOUR_TELEGRAM_CREDENTIAL_ID",
                    "name": "Telegram Default"
                }
            },
            "continueOnFail": true
        },
        {
            "parameters": {
                "url": "={{$node[\"Config\"].json[\"WEBHOOK_URL\"]}}",
                "method": "POST",
                "sendBody": true,
                "specifyBody": "json",
                "jsonBody": "={{JSON.stringify($json)}}"
            },
            "name": "Webhook Fallback",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                800,
                1000
            ]
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE error_logs SET sent_to_tg = TRUE WHERE id = $1",
                "additionalFields": {
                    "queryParams": "={{$json.id}}"
                }
            },
            "name": "Mark Sent",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 1,
            "position": [
                1000,
                800
            ],
            "credentials": {
                "postgres": {
                    "id": "YOUR_POSTGRES_CREDENTIAL_ID",
                    "name": "Postgres Default"
                }
            }
        },
        {
            "parameters": {
                "operation": "executeQuery",
                "query": "UPDATE error_logs SET processing_attempts = processing_attempts + 1, last_attempt = NOW() WHERE id = $1",
                "additionalFields": {
                    "queryParams": "={{$json.id}}"
                }
            },
            "name": "Mark Failed",
            "type": "n8n-nodes-base.postgres",
            "typeVersion": 1,
            "position": [
                1000,
                1100
            ],
            "credentials": {
                "postgres": {
                    "id": "YOUR_POSTGRES_CREDENTIAL_ID",
                    "name": "Postgres Default"
                }
            }
        }
    ],
    "connections": {
        "Error Trigger": {
            "main": [
                [
                    {
                        "node": "Log to DB",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Schedule": {
            "main": [
                [
                    {
                        "node": "Fetch Pending",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch Pending": {
            "main": [
                [
                    {
                        "node": "SplitInBatches",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "SplitInBatches": {
            "main": [
                [
                    {
                        "node": "Telegram",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Telegram": {
            "main": [
                [
                    {
                        "node": "Mark Sent",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Webhook Fallback",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Webhook Fallback": {
            "main": [
                [
                    {
                        "node": "Mark Sent",
                        "type": "main",
                        "index": 0
                    }
                ],
                [
                    {
                        "node": "Mark Failed",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "settings": {},
    "staticData": null,
    "tags": []
}