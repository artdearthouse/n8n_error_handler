{
    "name": "Bootstrap Error Handler",
    "nodes": [
        {
            "parameters": {},
            "name": "Manual Trigger",
            "type": "n8n-nodes-base.manualTrigger",
            "typeVersion": 1,
            "position": [
                0,
                300
            ]
        },
        {
            "parameters": {
                "values": {
                    "string": [
                        {
                            "name": "POSTGRES_CREDENTIAL_ID",
                            "value": "YOUR_POSTGRES_CREDENTIAL_ID"
                        },
                        {
                            "name": "TELEGRAM_CREDENTIAL_ID",
                            "value": "YOUR_TELEGRAM_CREDENTIAL_ID"
                        },
                        {
                            "name": "N8N_API_CREDENTIAL_ID",
                            "value": "YOUR_N8N_API_CREDENTIAL_ID"
                        },
                        {
                            "name": "TELEGRAM_CHAT_ID",
                            "value": "YOUR_CHAT_ID"
                        },
                        {
                            "name": "TELEGRAM_THREAD_ID",
                            "value": "YOUR_THREAD_ID"
                        },
                        {
                            "name": "WEBHOOK_URL",
                            "value": "YOUR_WEBHOOK_URL"
                        }
                    ]
                }
            },
            "name": "Configuration",
            "type": "n8n-nodes-base.set",
            "typeVersion": 1,
            "position": [
                200,
                300
            ]
        },
        {
            "parameters": {
                "url": "https://raw.githubusercontent.com/artdearthouse/n8n_error_handler/main/workflows/error_capture.json",
                "method": "GET",
                "responseFormat": "json"
            },
            "name": "Fetch Capture",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                400,
                200
            ]
        },
        {
            "parameters": {
                "url": "https://raw.githubusercontent.com/artdearthouse/n8n_error_handler/main/workflows/error_processor.json",
                "method": "GET",
                "responseFormat": "json"
            },
            "name": "Fetch Processor",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                400,
                400
            ]
        },
        {
            "parameters": {
                "url": "https://raw.githubusercontent.com/artdearthouse/n8n_error_handler/main/workflows/bootstrap_manager.json",
                "method": "GET",
                "responseFormat": "json"
            },
            "name": "Fetch Bootstrap",
            "type": "n8n-nodes-base.httpRequest",
            "typeVersion": 4.1,
            "position": [
                400,
                600
            ]
        },
        {
            "parameters": {
                "functionCode": "const config = $items(\"Configuration\")[0].json;\n\nfunction replaceConfig(jsonObj) {\n    let str = JSON.stringify(jsonObj);\n    str = str.replace(/YOUR_POSTGRES_CREDENTIAL_ID/g, config.POSTGRES_CREDENTIAL_ID);\n    str = str.replace(/YOUR_TELEGRAM_CREDENTIAL_ID/g, config.TELEGRAM_CREDENTIAL_ID);\n    str = str.replace(/YOUR_N8N_API_CREDENTIAL_ID/g, config.N8N_API_CREDENTIAL_ID);\n    str = str.replace(/YOUR_CHAT_ID/g, config.TELEGRAM_CHAT_ID);\n    str = str.replace(/YOUR_THREAD_ID/g, config.TELEGRAM_THREAD_ID);\n    str = str.replace(/YOUR_WEBHOOK_URL/g, config.WEBHOOK_URL);\n    return JSON.parse(str);\n}\n\nconst captureRaw = $items(\"Fetch Capture\")[0].json;\nconst processorRaw = $items(\"Fetch Processor\")[0].json;\nconst bootstrapRaw = $items(\"Fetch Bootstrap\")[0].json;\n\nreturn [\n    {\n        json: {\n            capture: replaceConfig(captureRaw),\n            processor: replaceConfig(processorRaw),\n            bootstrap: bootstrapRaw // Do not replace config in bootstrap to preserve original template or maybe we should? Let's leave it raw for now so it updates to the clean version.\n        }\n    }\n];"
            },
            "name": "Prepare Workflows",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                600,
                300
            ]
        },
        {
            "parameters": {
                "resource": "workflow",
                "operation": "update",
                "name": "n8n_error_handler",
                "active": true,
                "updateFields": {
                    "nodes": "={{$json.capture.nodes}}",
                    "connections": "={{$json.capture.connections}}"
                }
            },
            "name": "Upsert Capture",
            "type": "n8n-nodes-base.n8n",
            "typeVersion": 1,
            "position": [
                800,
                200
            ],
            "credentials": {
                "n8nApi": {
                    "id": "={{$node[\"Configuration\"].json[\"N8N_API_CREDENTIAL_ID\"]}}",
                    "name": "n8n API"
                }
            }
        },
        {
            "parameters": {
                "resource": "workflow",
                "operation": "update",
                "name": "Error Processor",
                "active": true,
                "updateFields": {
                    "nodes": "={{$json.processor.nodes}}",
                    "connections": "={{$json.processor.connections}}"
                }
            },
            "name": "Upsert Processor",
            "type": "n8n-nodes-base.n8n",
            "typeVersion": 1,
            "position": [
                800,
                400
            ],
            "credentials": {
                "n8nApi": {
                    "id": "={{$node[\"Configuration\"].json[\"N8N_API_CREDENTIAL_ID\"]}}",
                    "name": "n8n API"
                }
            }
        },
        {
            "parameters": {
                "resource": "workflow",
                "operation": "getAll",
                "returnAll": true
            },
            "name": "Get All Workflows",
            "type": "n8n-nodes-base.n8n",
            "typeVersion": 1,
            "position": [
                1000,
                300
            ],
            "credentials": {
                "n8nApi": {
                    "id": "={{$node[\"Configuration\"].json[\"N8N_API_CREDENTIAL_ID\"]}}",
                    "name": "n8n API"
                }
            }
        },
        {
            "parameters": {
                "functionCode": "// Update settings for all workflows\nconst captureWfId = $items(\"Upsert Capture\")[0].json.id;\nconst allWorkflows = $items(\"Get All Workflows\");\n\nconst updates = [];\n\nfor (const wf of allWorkflows) {\n    const wfData = wf.json;\n    if (wfData.id === captureWfId) continue;\n    if (wfData.name === \"Bootstrap Error Handler\") continue;\n\n    if (wfData.settings && wfData.settings.errorWorkflow === captureWfId) continue;\n\n    updates.push({\n        id: wfData.id,\n        settings: {\n            ...wfData.settings,\n            errorWorkflow: captureWfId\n        }\n    });\n}\n\nreturn updates.map(u => ({ json: u }));"
            },
            "name": "Prepare Settings Updates",
            "type": "n8n-nodes-base.function",
            "typeVersion": 1,
            "position": [
                1200,
                300
            ]
        },
        {
            "parameters": {
                "resource": "workflow",
                "operation": "update",
                "id": "={{$json.id}}",
                "updateFields": {
                    "settings": "={{$json.settings}}"
                }
            },
            "name": "Apply Settings",
            "type": "n8n-nodes-base.n8n",
            "typeVersion": 1,
            "position": [
                1400,
                300
            ],
            "credentials": {
                "n8nApi": {
                    "id": "={{$node[\"Configuration\"].json[\"N8N_API_CREDENTIAL_ID\"]}}",
                    "name": "n8n API"
                }
            }
        },
        {
            "parameters": {
                "resource": "workflow",
                "operation": "update",
                "id": "={{$workflow.id}}",
                "updateFields": {
                    "nodes": "={{$node[\"Prepare Workflows\"].json[\"bootstrap\"][\"nodes\"]}}",
                    "connections": "={{$node[\"Prepare Workflows\"].json[\"bootstrap\"][\"connections\"]}}"
                }
            },
            "name": "Self Update",
            "type": "n8n-nodes-base.n8n",
            "typeVersion": 1,
            "position": [
                1600,
                300
            ],
            "credentials": {
                "n8nApi": {
                    "id": "={{$node[\"Configuration\"].json[\"N8N_API_CREDENTIAL_ID\"]}}",
                    "name": "n8n API"
                }
            }
        }
    ],
    "connections": {
        "Manual Trigger": {
            "main": [
                [
                    {
                        "node": "Configuration",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Configuration": {
            "main": [
                [
                    {
                        "node": "Fetch Capture",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch Capture": {
            "main": [
                [
                    {
                        "node": "Fetch Processor",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch Processor": {
            "main": [
                [
                    {
                        "node": "Fetch Bootstrap",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Fetch Bootstrap": {
            "main": [
                [
                    {
                        "node": "Prepare Workflows",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare Workflows": {
            "main": [
                [
                    {
                        "node": "Upsert Capture",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Upsert Capture": {
            "main": [
                [
                    {
                        "node": "Upsert Processor",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Upsert Processor": {
            "main": [
                [
                    {
                        "node": "Get All Workflows",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Get All Workflows": {
            "main": [
                [
                    {
                        "node": "Prepare Settings Updates",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Prepare Settings Updates": {
            "main": [
                [
                    {
                        "node": "Apply Settings",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        },
        "Apply Settings": {
            "main": [
                [
                    {
                        "node": "Self Update",
                        "type": "main",
                        "index": 0
                    }
                ]
            ]
        }
    },
    "settings": {},
    "staticData": null,
    "tags": []
}